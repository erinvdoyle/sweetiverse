{% extends "base.html" %}
{% load static %}
{% load bag_tools %}


{% block content %}
<div class="sweet-detail-bg">
    <div class="container-xl py-5 sweet-detail-wrapper">
      <div class="row justify-content-center align-items-start g-5 flex-column flex-md-row">
  
        <!-- Checkout Form Section -->
        <div class="col-md-8">
          <div class="sweet-info styled-card p-4">
            <h2 class="logo-font sweet-text-highlight mb-4">CHECKOUT</h2>
  
            <p class="mb-3">Please fill out your details below to complete your SWEETi order.</p>
  
    
<div class="sweet-info styled-card p-4 mb-4">
  <h3 class="logo-font mb-3">Order Summary</h3>
  <div class="row fw-bold border-bottom pb-2 mb-2">
    <div class="col-6">Item</div>
    <div class="col-3 text-center">Qty</div>
    <div class="col-3 text-end">Subtotal</div>
  </div>

  {% for item in bag_items %}
    <div class="row align-items-center mb-2">
      <div class="col-6">
        {% if item.product.image %}
        <img src="{{ item.product.image.url|default_if_none:MEDIA_URL|add:'noimage.png' }}" alt="..." />
        {% else %}
          <img src="{{ MEDIA_URL }}noimage.png" alt="{{ item.product.name }}" width="50" class="me-2 rounded">
        {% endif %}
        {{ item.product.name }}
      </div>
      <div class="col-3 text-center">{{ item.quantity }}</div>
      <div class="col-3 text-end">£{{ item.product.price | calc_subtotal:item.quantity }}</div>
    </div>
  {% endfor %}

  <hr>
  <div class="row fw-bold">
    <div class="col-6">Total</div>
    <div class="col-6 text-end">£{{ total|floatformat:2 }}</div>
    <div class="col-6">Delivery</div>
    <div class="col-6 text-end">£{{ delivery|floatformat:2 }}</div>
    <div class="col-6">Grand Total</div>
    <div class="col-6 text-end">£{{ grand_total|floatformat:2 }}</div>
  </div>
</div>


            <form method="POST" action="{% url 'checkout' %}" id="payment-form">
                {% csrf_token %}
                <fieldset class="sweeti-fieldset mb-4 p-4 rounded">
                  <legend class="logo-font fs-4 mb-3">Details</legend>
                  {{ order_form.full_name|as_crispy_field }}
                  {{ order_form.email|as_crispy_field }}
                </fieldset>
              
                <fieldset class="sweeti-fieldset mb-4 p-4 rounded">
                  <legend class="logo-font fs-4 mb-3">Delivery</legend>
                  {{ order_form.phone_number|as_crispy_field }}
                  {{ order_form.street_address1|as_crispy_field }}
                  {{ order_form.street_address2|as_crispy_field }}
                  {{ order_form.city|as_crispy_field }}
                  {{ order_form.postcode|as_crispy_field }}
                  {{ order_form.county|as_crispy_field }}
                  {{ order_form.country|as_crispy_field }}
              
                  {% if user.is_authenticated %}
                    <div class="form-check mt-3">
                      {{ order_form.save_info }}
                      <label class="form-check-label ms-2">
                        Save this info for next time!
                      </label>
                    </div>
                  {% else %}
                    <p class="mt-3"><a href="{% url 'account_signup' %}">Create an account</a> or <a href="{% url 'account_login' %}">Login</a> to save this info.</p>
                  {% endif %}
                </fieldset>
              
                <fieldset class="sweeti-fieldset mb-4 p-4 rounded">
                  <legend class="logo-font fs-4 mb-3">Payment</legend>
                  <div id="card-element" class="mb-3"></div>
                  <div id="card-errors" role="alert"></div>
                </fieldset>
              
                <div class="d-flex justify-content-between align-items-center">
                  <a href="{% url 'view_bag' %}" class="btn btn-outline-secondary rounded-pill">
                    ← BACK TO BAG
                  </a>
                  <button id="submit-button" class="btn sweeti-add-btn rounded-pill px-4">
                    COMEPLETE ORDER
                  </button>
                </div>
              
                <p class="mt-3 text-muted text-center small">
                  Your card will be charged securely via Stripe.
                </p>
              </form>
              
          </div>
        </div>
      </div>
    </div>
  </div>  
{% endblock %}
